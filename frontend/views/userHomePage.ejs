<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Document</title>
	</head>
	<body>
		<div><h1>Hello User</h1></div>
		<br />
		<a href="/user/borrow">see all the avalable books in library</a>
		<br />
		<br />
        <a href="/user/history">see history of borrowed books</a>
		<br />
		<br />
        <a href="/user/delete">delete account</a>
		<br />
		<br />
		<button onclick="deleteRequest()" id="submitButton">signout</button>
		<h3>Table of all the borrowed books</h3>
		<div id="statusBar"></div>
		<table border="1" id="borrowedTable">
			<thead>
				<tr>
					<th>book ID</th>
					<th>title</th>
					<th>author</th>
					<th>Return</th>
				</tr>
			</thead>
			<tbody></tbody>
		</table>
	</body>
	<script>
		function deleteRequest() {
			window.localStorage.removeItem("token");
			window.location.href = "/";
		}
		const backendUrl = "<%=backend%>";
		let storageToken = window.localStorage.getItem("token");
		if (!window.localStorage.getItem("token")) {
			window.location.href = "/";
		}
		storageToken = JSON.parse(storageToken);
		fetch(backendUrl + "/user/book/borrowed", {
			method: "GET",
			headers: {
				Authorization: `Bearer ${storageToken}`,
			},
		})
			.then((res) => res.json())
			.then((books) => {
				const tableBody = document.querySelector("#borrowedTable tbody");
				// Clear any existing rows
				tableBody.innerHTML = "";

				// Loop through the array of books
				books.forEach((book) => {
					// Create a new row
					const row = document.createElement("tr");

					const idCell = document.createElement("td");
					idCell.textContent = book.id;
					row.appendChild(idCell);

					const titleCell = document.createElement("td");
					titleCell.textContent = book.title;
					row.appendChild(titleCell);

					const authorCell = document.createElement("td");
					authorCell.textContent = book.author;
					row.appendChild(authorCell);

					const returnCell = document.createElement("td");
					returnCell.innerHTML = `<a href=/user/return/${book.id}>return</a>`;
					row.appendChild(returnCell);

					tableBody.appendChild(row);
				});
			})
			.catch((err) => {
				const statusBar = document.getElementById("statusBar");
				statusBar.innerHTML = `${err.status} ${err.message}`;
			});
	</script>
</html>
